name: Build & Deploy Backend (Image)

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/backend/**"
      - ".github/workflows/deploy-backend-image.yml"
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  REPO: ${{ secrets.ECR_REPOSITORY }}
  IMAGE_TAG: ${{ github.sha }}
  DOCKERFILE_PATH: ./apps/backend/Dockerfile
  CONTEXT: .

concurrency:
  group: backend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-push:
    name: Build (linux/amd64) & Push to ECR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2
        with:
          region: ${{ env.AWS_REGION }}

      - name: Build and push (linux/amd64)
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.CONTEXT }}
          file: ${{ env.DOCKERFILE_PATH }}
          platforms: linux/amd64
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.REPO }}:${{ env.IMAGE_TAG }}

      - name: Output image uri
        id: image
        run: |
          echo "image_uri=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.REPO }}:${{ env.IMAGE_TAG }}" >> $GITHUB_OUTPUT

  update-lambda:
    name: Update or Create Lambda (Image)
    needs: build-push
    runs-on: ubuntu-latest
    env:
      REGION: ${{ env.AWS_REGION }}
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.REGION }}

      - name: Determine function package type
        id: check
        run: |
          FN="${{ secrets.LAMBDA_FUNCTION_NAME }}"
          if aws lambda get-function --function-name "$FN" --region "${{ env.REGION }}" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            type=$(aws lambda get-function-configuration --function-name "$FN" --region "${{ env.REGION }}" --query 'PackageType' --output text)
            echo "packagetype=$type" >> $GITHUB_OUTPUT
            role=$(aws lambda get-function-configuration --function-name "$FN" --region "${{ env.REGION }}" --query 'Role' --output text)
            echo "role=$role" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "packagetype=NONE" >> $GITHUB_OUTPUT
          fi

      - name: Update existing Image-function or create new Image function
        run: |
          IMAGE_URI="${{ steps.build-push.outputs.image_uri }}"
          FN="${{ secrets.LAMBDA_FUNCTION_NAME }}"
          EXISTS="${{ steps.check.outputs.exists }}"
          PACKTYPE="${{ steps.check.outputs.packagetype }}"

          echo "IMAGE_URI=$IMAGE_URI"
          echo "Function exists = $EXISTS ; PackageType = $PACKTYPE"

          if [ "$EXISTS" = "true" ] && [ "$PACKTYPE" = "Image" ]; then
            echo "Updating existing image Lambda: $FN"
            aws lambda update-function-code \
              --function-name "$FN" \
              --image-uri "$IMAGE_URI" \
              --region "${{ env.REGION }}"
            exit 0
          fi

          # if exists and package type is Zip (or other), create a new function name by suffixing -image
          if [ "$EXISTS" = "true" ] && [ "$PACKTYPE" != "Image" ]; then
            NEW_FN="${FN}-image"
            echo "Existing function is ZIP. Creating new image-based function: $NEW_FN"
            # Use existing role from the old function (retrieved earlier)
            ROLE="${{ steps.check.outputs.role }}"
            if [ -z "$ROLE" ] || [ "$ROLE" = "None" ]; then
              echo "No role found from existing function. You can set LAMBDA_ROLE_ARN secret if needed."
              exit 1
            fi

            aws lambda create-function \
              --function-name "$NEW_FN" \
              --package-type Image \
              --code ImageUri="$IMAGE_URI" \
              --role "$ROLE" \
              --region "${{ env.REGION }}" \
              --timeout 10 \
              --memory-size 256
            echo "Created $NEW_FN"
            exit 0
          fi

          # if doesn't exist, create new function with given name
          if [ "$EXISTS" = "false" ]; then
            echo "Creating new image-based function: $FN"
            # require an execution role; prefer secret LAMBDA_ROLE_ARN if provided
            if [ -n "${{ secrets.LAMBDA_ROLE_ARN }}" ]; then
              ROLE="${{ secrets.LAMBDA_ROLE_ARN }}"
            else
              echo "Please set secret LAMBDA_ROLE_ARN with the Lambda execution role ARN, or create manually later."
              exit 1
            fi

            aws lambda create-function \
              --function-name "$FN" \
              --package-type Image \
              --code ImageUri="$IMAGE_URI" \
              --role "$ROLE" \
              --region "${{ env.REGION }}" \
              --timeout 10 \
              --memory-size 256
            exit 0
          fi
