name: Deploy Frontend

on:
  push:
    branches: [ "main" ]
    paths:
      - "apps/frontend/**"
      - ".github/workflows/deploy-frontend.yml"
  pull_request:
    branches: [ "main" ]
    paths:
      - "apps/frontend/**"
      - ".github/workflows/deploy-frontend.yml"

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ap-northeast-1
  PARAM_NAME_PROD: /giilu/prod/NEXT_PUBLIC_API_URL
  AWS_PAGER: ""
  AWS_MAX_ATTEMPTS: "3"
  AWS_RETRY_MODE: standard

concurrency:
  group: frontend-${{ github.ref }}
  cancel-in-progress: true

jobs:
  biome:
    name: Lint & Format (Biome)
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: apps/frontend
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
      - name: Install deps
        run: pnpm install --frozen-lockfile
      - name: Skip Biome (always true)
        run: |
          echo "Skipping Biome check"
          true
  deploy_preview:
    name: Deploy Preview (PR)
    needs: biome
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    env:
      AWS_EC2_METADATA_DISABLED: "true"
    defaults:
      run:
        shell: bash
        working-directory: apps/frontend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Inject runtime env (bucket, prefix)
        run: |
          echo "BUCKET=${{ secrets.AWS_FRONTEND_BUCKET }}" >> "$GITHUB_ENV"
          echo "PREVIEW_PREFIX=previews/pr-${{ github.event.pull_request.number }}" >> "$GITHUB_ENV"

      - name: Sanitize AWS env (avoid container-role)
        run: |
          set -euo pipefail
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_PROFILE AWS_DEFAULT_PROFILE
          unset AWS_CONTAINER_CREDENTIALS_FULL_URI AWS_CONTAINER_AUTHORIZATION_TOKEN AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
          unset AWS_WEB_IDENTITY_TOKEN_FILE AWS_ROLE_ARN
          echo "Sanitized AWS_* environment variables."

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Who am I (debug)
        run: aws sts get-caller-identity

      - name: Read API URL from SSM
        id: ssm
        run: |
          set -euo pipefail
          URL=$(aws ssm get-parameter \
            --name "${PARAM_NAME_PROD}" \
            --region "${AWS_REGION}" \
            --query "Parameter.Value" --output text)
          if [ -z "$URL" ] || [ "$URL" = "None" ]; then
            echo "SSM param empty"
            exit 1
          fi
          echo "api_url=$URL" >> "$GITHUB_OUTPUT"

      - name: Build (static export)
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.ssm.outputs.api_url }}
          NODE_ENV: production
        run: |
          set -euxo pipefail
          pnpm build
          test -d out
          echo "Built with NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}"

      - name: Ensure bucket exists
        run: |
          set -euo pipefail
          aws s3api head-bucket --bucket "$BUCKET" >/dev/null 2>&1 || {
            echo "Bucket not found: $BUCKET"
            exit 1
          }

      - name: Upload preview (long-cache assets)
        run: |
          set -euxo pipefail
          aws s3 sync "./out" "s3://$BUCKET/$PREVIEW_PREFIX" \
            --delete \
            --exclude "*" \
            --include "_next/static/*" \
            --include "assets/*" \
            --cache-control "public,max-age=31536000,immutable"

      - name: Upload preview (html no-cache)
        run: |
          set -euxo pipefail
          aws s3 sync "./out" "s3://$BUCKET/$PREVIEW_PREFIX" \
            --delete \
            --exclude "_next/*" \
            --exclude "assets/*" \
            --cache-control "no-cache"

      - name: Preview URL
        run: |
          echo "Preview path: s3://$BUCKET/$PREVIEW_PREFIX/index.html"

  deploy_prod:
    name: Deploy Production (main)
    needs: biome
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    env:
      AWS_EC2_METADATA_DISABLED: "true"
    defaults:
      run:
        shell: bash
        working-directory: apps/frontend
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Inject runtime env (bucket)
        run: |
          echo "BUCKET=${{ secrets.AWS_FRONTEND_BUCKET }}" >> "$GITHUB_ENV"

      - name: Sanitize AWS env (avoid container-role)
        run: |
          set -euo pipefail
          unset AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY AWS_SESSION_TOKEN AWS_PROFILE AWS_DEFAULT_PROFILE
          unset AWS_CONTAINER_CREDENTIALS_FULL_URI AWS_CONTAINER_AUTHORIZATION_TOKEN AWS_CONTAINER_CREDENTIALS_RELATIVE_URI
          unset AWS_WEB_IDENTITY_TOKEN_FILE AWS_ROLE_ARN
          echo "Sanitized AWS_* environment variables."

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Who am I (debug)
        run: aws sts get-caller-identity

      - name: Read API URL from SSM (prod)
        id: ssm
        run: |
          set -euo pipefail
          VALUE=$(aws ssm get-parameter \
            --name "${PARAM_NAME_PROD}" \
            --region "${AWS_REGION}" \
            --query "Parameter.Value" --output text)
          if [ -z "$VALUE" ] || [ "$VALUE" = "None" ]; then
            echo "SSM param empty"
            exit 1
          fi
          echo "api_url=$VALUE" >> "$GITHUB_OUTPUT"
          echo "Resolved NEXT_PUBLIC_API_URL: $VALUE"

      - name: Build (static export)
        env:
          NEXT_PUBLIC_API_URL: ${{ steps.ssm.outputs.api_url }}
          NODE_ENV: production
        run: |
          set -euxo pipefail
          pnpm build
          test -d out
          echo "Built with NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}"

      - name: Sync to S3 (prod)
        run: |
          set -euxo pipefail
          aws s3 sync "./out" "s3://$BUCKET" --delete

      - name: CloudFront Invalidation (prod)
        env:
          CF_DISTRIBUTION_ID_PROD: ${{ secrets.CF_DISTRIBUTION_ID_PROD }}
        run: |
          set -euxo pipefail
          aws cloudfront create-invalidation \
            --distribution-id "${CF_DISTRIBUTION_ID_PROD}" \
            --paths "/*"
